{% extends "base.html" %}

{% block title %}NYU Study Space Status - Home{% endblock %}

{% block content %}
<div class="header-section">
    <h2>Campus Study Space Reviews</h2>
    <p>Real-time reviews and ratings of NYU study spaces across all locations</p>
</div>

<div class="filters">
    <button class="filter-btn active" data-filter="all">All Spaces</button>
    <button class="filter-btn" data-filter="high-rated">Highly Rated (4+)</button>
    <button class="filter-btn" data-filter="quiet">Quiet Spaces</button>
    <button class="filter-btn" data-filter="available">Less Crowded</button>
</div>

<div class="space-grid" id="spaceGrid">
    {% if spaces %}
        {% for space in spaces %}
        <div class="space-card" 
             data-rating="{{ space.avg_rating }}" 
             data-silence="{{ space.avg_silence }}"
             data-crowdedness="{{ space.avg_crowdedness }}">
            <div class="space-header">
                <h3>{{ space.building }}</h3>
                <div class="rating-badge">
                    <span class="stars">{{ '★' * (space.avg_rating|int) }}{{ '☆' * (5 - (space.avg_rating|int)) }}</span>
                    <span class="rating-number">{{ space.avg_rating }}/5</span>
                </div>
            </div>
            <div class="space-details">
                <p><strong>Location:</strong> {{ space.sublocation }}</p>
                
                <div class="rating-row">
                    <label>Overall Rating:</label>
                    <div class="rating-stars">{{ '★' * (space.avg_rating|int) }}{{ '☆' * (5 - (space.avg_rating|int)) }}</div>
                    <span>{{ space.avg_rating }}/5</span>
                </div>
                
                <div class="rating-row">
                    <label>Silence Level:</label>
                    <div class="rating-stars">{{ '★' * (space.avg_silence|int) }}{{ '☆' * (5 - (space.avg_silence|int)) }}</div>
                    <span>{{ space.avg_silence }}/5</span>
                </div>
                
                <div class="rating-row">
                    <label>Crowdedness:</label>
                    <div class="rating-stars">{{ '★' * (space.avg_crowdedness|int) }}{{ '☆' * (5 - (space.avg_crowdedness|int)) }}</div>
                    <span>{{ space.avg_crowdedness }}/5</span>
                </div>
                
                <p class="review-count">{{ space.review_count }} review{{ 's' if space.review_count != 1 else '' }}</p>
                
                {% if space.last_review %}
                <div class="latest-review">
                    <p><em>"{{ space.last_review[:100] }}{{ '...' if space.last_review|length > 100 else '' }}"</em></p>
                </div>
                {% endif %}
                
                <p class="last-updated">
                    Last reviewed: {{ space.last_updated.strftime('%Y-%m-%d %H:%M') if space.last_updated else 'No reviews yet' }}
                    {% if space.reported_by %}
                    <br><small>by {{ space.reported_by }}</small>
                    {% endif %}
                </p>
            </div>
            {% if current_user.is_authenticated %}
            <button class="review-btn" onclick="openReviewModal('{{ space._id }}', '{{ space.building }}', '{{ space.sublocation }}')">
                Submit Review
            </button>
            {% else %}
            <button class="review-btn review-btn-disabled" title="Login required to submit review">
                Login to Review
            </button>
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
        <div class="no-spaces">
            <p>No study spaces found. Add some study spaces to get started!</p>
        </div>
    {% endif %}
</div>

<div class="auto-refresh">
    <label>
        <input type="checkbox" id="autoRefresh" checked>
        Auto-refresh every 30 seconds
    </label>
</div>

<!-- Review Modal -->
<div id="reviewModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeReviewModal()">&times;</span>
        <h2>Submit Study Space Review</h2>
        <p id="modalSpaceName"></p>
        <form id="reviewForm">
            <input type="hidden" id="reviewSpaceId" name="space_id">
            
            <label for="rating">Overall Rating (1-5 stars):</label>
            <div class="star-rating">
                <input type="radio" id="rating5" name="rating" value="5" required>
                <label for="rating5">★</label>
                <input type="radio" id="rating4" name="rating" value="4">
                <label for="rating4">★</label>
                <input type="radio" id="rating3" name="rating" value="3">
                <label for="rating3">★</label>
                <input type="radio" id="rating2" name="rating" value="2">
                <label for="rating2">★</label>
                <input type="radio" id="rating1" name="rating" value="1">
                <label for="rating1">★</label>
            </div>
            
            <label for="silence">Silence Level (1-5, 5 = very quiet):</label>
            <div class="star-rating">
                <input type="radio" id="silence5" name="silence" value="5" required>
                <label for="silence5">★</label>
                <input type="radio" id="silence4" name="silence" value="4">
                <label for="silence4">★</label>
                <input type="radio" id="silence3" name="silence" value="3">
                <label for="silence3">★</label>
                <input type="radio" id="silence2" name="silence" value="2">
                <label for="silence2">★</label>
                <input type="radio" id="silence1" name="silence" value="1">
                <label for="silence1">★</label>
            </div>
            
            <label for="crowdedness">Crowdedness (1-5, 5 = very crowded):</label>
            <div class="star-rating">
                <input type="radio" id="crowdedness5" name="crowdedness" value="5" required>
                <label for="crowdedness5">★</label>
                <input type="radio" id="crowdedness4" name="crowdedness" value="4">
                <label for="crowdedness4">★</label>
                <input type="radio" id="crowdedness3" name="crowdedness" value="3">
                <label for="crowdedness3">★</label>
                <input type="radio" id="crowdedness2" name="crowdedness" value="2">
                <label for="crowdedness2">★</label>
                <input type="radio" id="crowdedness1" name="crowdedness" value="1">
                <label for="crowdedness1">★</label>
            </div>
            
            <label for="review">Your Review (optional):</label>
            <textarea id="review" name="review" rows="4" placeholder="Share your experience with this study space..."></textarea>
            
            <button type="submit" class="btn">Submit Review</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Auto-refresh functionality
    let refreshInterval;
    const autoRefreshCheckbox = document.getElementById('autoRefresh');
    
    function refreshSpaces() {
        location.reload();
    }
    
    autoRefreshCheckbox.addEventListener('change', function() {
        if (this.checked) {
            refreshInterval = setInterval(refreshSpaces, 30000);
        } else {
            clearInterval(refreshInterval);
        }
    });
    
    // Start auto-refresh
    if (autoRefreshCheckbox.checked) {
        refreshInterval = setInterval(refreshSpaces, 30000);
    }
    
    // Filter functionality
    const filterButtons = document.querySelectorAll('.filter-btn');
    const spaceCards = document.querySelectorAll('.space-card');
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            const filter = this.dataset.filter;
            
            spaceCards.forEach(card => {
                const rating = parseFloat(card.dataset.rating);
                const silence = parseFloat(card.dataset.silence);
                const crowdedness = parseFloat(card.dataset.crowdedness);
                
                let show = false;
                
                if (filter === 'all') {
                    show = true;
                } else if (filter === 'high-rated' && rating >= 4) {
                    show = true;
                } else if (filter === 'quiet' && silence >= 4) {
                    show = true;
                } else if (filter === 'available' && crowdedness <= 2) {
                    show = true;
                }
                
                card.style.display = show ? 'block' : 'none';
            });
        });
    });
    
    // Review Modal functionality
    const modal = document.getElementById('reviewModal');
    
    function openReviewModal(spaceId, building, sublocation) {
        document.getElementById('reviewSpaceId').value = spaceId;
        document.getElementById('modalSpaceName').textContent = building + ' - ' + sublocation;
        modal.style.display = 'block';
    }
    
    function closeReviewModal() {
        modal.style.display = 'none';
        document.getElementById('reviewForm').reset();
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target == modal) {
            closeReviewModal();
        }
    }
    
    // Handle form submission
    document.getElementById('reviewForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = {
            space_id: document.getElementById('reviewSpaceId').value,
            rating: parseInt(document.querySelector('input[name="rating"]:checked').value),
            silence: parseInt(document.querySelector('input[name="silence"]:checked').value),
            crowdedness: parseInt(document.querySelector('input[name="crowdedness"]:checked').value),
            review: document.getElementById('review').value
        };
        
        try {
            const response = await fetch('/api/reviews', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });
            
            if (response.ok) {
                alert('Thank you for your review! Your feedback has been submitted.');
                closeReviewModal();
                refreshSpaces();
            } else {
                const data = await response.json();
                alert('Error submitting review: ' + (data.error || 'Please try again.'));
            }
        } catch (error) {
            alert('Error submitting review: ' + error.message);
        }
    });
</script>
{% endblock %}
